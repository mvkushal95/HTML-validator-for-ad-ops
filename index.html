<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-THRPXSR9');</script>
<!-- End Google Tag Manager -->
  <title>CM360 Zip Creative Validator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    h1 { color: #333; }
    input[type="file"] { margin-top: 10px; }
    .results { margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .pass { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    p { margin: 5px 0; }
    iframe { width: 300px; height: 250px; border: 1px solid #ccc; margin-top: 10px; }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-THRPXSR9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  <h1>CM360 Zip Creative Validator</h1>
  <input type="file" id="zipInput" accept=".zip" />
  <div class="results" id="results"></div>

<script>
document.getElementById('zipInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "Processing zip...";

  JSZip.loadAsync(file).then(zip => {
    // Find HTML entry file (not just index.html, fallback to first .html file)
    let htmlFileName = Object.keys(zip.files).find(name => /index\.html$/i.test(name));
    if (!htmlFileName) {
      htmlFileName = Object.keys(zip.files).find(name => /\.html$/i.test(name));
    }

    if (!htmlFileName) {
      resultsDiv.innerHTML = "<p class='fail'>✘ No HTML file found in zip</p>";
      return;
    }

    zip.file(htmlFileName).async("string").then(htmlContent => {
      validateCreative(htmlContent, zip, htmlFileName);
    });
  }).catch(err => {
    resultsDiv.innerHTML = `<p class='fail'>✘ Error reading zip: ${err.message}</p>`;
  });
});

function validateCreative(html, zip, htmlFileName) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = ""; // Clear previous results

  // Regex to check clickTag or GWD Exit
  const clickHandlerRegex = /(clickTag|gwdAd\.exit)/i;
  const hasClickHandler = clickHandlerRegex.test(html);

  if (hasClickHandler) {
    resultsDiv.innerHTML += "<p class='pass'>✔ Click Handler Found (clickTag or GWD Exit)</p>";

    // Try extracting landing page from clickTag
    const urlExtractionRegex = /var\s+clickTag\s*=\s*['"](https?:\/\/[^'"]+)['"]/i;
    const urlMatch = html.match(urlExtractionRegex);

    if (urlMatch && urlMatch[1]) {
      const landingPage = urlMatch[1];
      resultsDiv.innerHTML += `<p class='pass'>✔ Landing Page: ${landingPage}</p>`;
    } else {
      resultsDiv.innerHTML += "<p class='fail'>✘ Landing Page URL could not be extracted from clickTag variable.</p>";
    }

    // ✅ Render the actual creative in an iframe
    const iframe = document.createElement("iframe");
    iframe.width = "300";
    iframe.height = "250";
    iframe.style.border = "1px solid #ccc";

    // Blob URL for iframe
    const blob = new Blob([html], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    iframe.src = url;

    resultsDiv.appendChild(document.createElement("hr"));
    resultsDiv.innerHTML += "<p class='pass'>✔ Creative Preview:</p>";
    resultsDiv.appendChild(iframe);

  } else {
    resultsDiv.innerHTML += "<p class='fail'>✘ Click Handler Missing (No clickTag variable or GWD Exit found)</p>";
  }
}
</script>
</body>
</html>
