<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-THRPXSR9');</script>
<!-- End Google Tag Manager -->
  <title>CM360 Zip Creative Validator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    h1 { color: #333; }
    input[type="file"] { margin-top: 10px; }
    .results { margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .pass { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    p { margin: 5px 0; }
    iframe { border: 1px solid #ccc; background: #fff; margin-top: 10px; overflow: hidden; }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-THRPXSR9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  <h1>CM360 Zip Creative Validator</h1>
  <input type="file" id="zipInput" accept=".zip" />
  <div class="results" id="results"></div>

<script>
document.getElementById('zipInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "Processing zip...";

  JSZip.loadAsync(file).then(zip => {
    let htmlFileName = Object.keys(zip.files).find(name => /index\.html$/i.test(name));
    if (!htmlFileName) {
      htmlFileName = Object.keys(zip.files).find(name => /\.html$/i.test(name));
    }

    if (!htmlFileName) {
      resultsDiv.innerHTML = "<p class='fail'>✘ No HTML file found in zip</p>";
      return;
    }

    zip.file(htmlFileName).async("string").then(htmlContent => {
      validateCreative(htmlContent, zip, htmlFileName);
    });
  }).catch(err => {
    resultsDiv.innerHTML = `<p class='fail'>✘ Error reading zip: ${err.message}</p>`;
  });
});

async function validateCreative(html, zip, htmlFileName) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  // ✅ Check for click handler
  const clickHandlerRegex = /(clickTag|gwdAd\.exit|gwd\.actions\.gwdGoogleAd\.exit)/i;
  const hasClickHandler = clickHandlerRegex.test(html);

  let landingPage = null;
  if (hasClickHandler) {
    resultsDiv.innerHTML += "<p class='pass'>✔ Click Handler Found</p>";

    // Extract landing page
    const clickTagRegex = /var\s+clickTag\s*=\s*['"](https?:\/\/[^'"]+)['"]/i;
    const clickTagMatch = html.match(clickTagRegex);
    if (clickTagMatch && clickTagMatch[1]) {
      landingPage = clickTagMatch[1];
    }

    const gwdExitRegex = /gwd\.actions\.gwdGoogleAd\.exit\([^,]+,\s*['"]clickTag['"]\s*,\s*['"](https?:\/\/[^'"]+)['"]/i;
    const gwdExitMatch = html.match(gwdExitRegex);
    if (!landingPage && gwdExitMatch && gwdExitMatch[1]) {
      landingPage = gwdExitMatch[1];
    }

    if (landingPage) {
      resultsDiv.innerHTML += `<p class='pass'>✔ Landing Page: <a href="${landingPage}" target="_blank">${landingPage}</a></p>`;
    } else {
      resultsDiv.innerHTML += "<p class='fail'>✘ Landing Page URL could not be extracted.</p>";
    }
  } else {
    resultsDiv.innerHTML += "<p class='fail'>✘ Click Handler Missing</p>";
  }

  // ✅ Build Blob URLs for assets
  const assetUrls = {};
  await Promise.all(Object.keys(zip.files).map(async name => {
    if (!zip.files[name].dir && !name.endsWith(".html")) {
      const ext = name.split(".").pop().toLowerCase();
      let mime = "application/octet-stream";
      if (["png","jpg","jpeg","gif","webp"].includes(ext)) mime = "image/" + (ext==="jpg"?"jpeg":ext);
      if (ext === "svg") mime = "image/svg+xml";
      if (ext === "css") mime = "text/css";
      if (ext === "js") mime = "application/javascript";

      const blob = await zip.files[name].async("blob");
      assetUrls[name] = URL.createObjectURL(new Blob([blob], {type: mime}));
    }
  }));

  // Replace asset references
  let updatedHtml = html;
  for (const [path, blobUrl] of Object.entries(assetUrls)) {
    const safePath = path.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&");
    const regex = new RegExp(safePath, "g");
    updatedHtml = updatedHtml.replace(regex, blobUrl);
  }

  // ✅ Inject clickTag script + full-page overlay link
  if (landingPage) {
    updatedHtml = `
      <script>
        var clickTag = "${landingPage}";
        window.clickTag = clickTag;
      <\/script>
      <a href="${landingPage}" target="_blank" style="
        position:fixed;
        top:0;left:0;
        width:100%;
        height:100%;
        z-index:999999;
        display:block;
        background:transparent;
        cursor:pointer;
      "></a>
    ` + updatedHtml;
  }

  // ✅ Get ad size
  let width = 300, height = 250;
  const sizeMatch = html.match(/<meta[^>]+name=['"]ad.size['"][^>]+content=['"]width=(\\d+),height=(\\d+)['"]/i);
  if (sizeMatch) {
    width = sizeMatch[1];
    height = sizeMatch[2];
  }

  // ✅ Render in iframe
  const iframe = document.createElement("iframe");
  iframe.width = width;
  iframe.height = height;
  iframe.scrolling = "no";
  iframe.style.overflow = "hidden";
  iframe.style.border = "1px solid #ccc";

  const blob = new Blob([updatedHtml], { type: "text/html" });
  iframe.src = URL.createObjectURL(blob);

  // Adjust size after load
  iframe.onload = () => {
    try {
      const doc = iframe.contentWindow.document;
      const w = doc.body.scrollWidth;
      const h = doc.body.scrollHeight;
      if (w > 0 && h > 0) {
        iframe.width = w;
        iframe.height = h;
      }
      if (landingPage) {
        iframe.contentWindow.clickTag = landingPage;
      }
    } catch (e) {
      console.warn("Iframe resize or clickTag injection failed:", e);
    }
  };

  resultsDiv.appendChild(document.createElement("hr"));
  resultsDiv.innerHTML += "<p class='pass'>✔ Creative Preview:</p>";
  resultsDiv.appendChild(iframe);
}
</script>
</body>
</html>
